# KRule AI Features - Complete Setup Guide

This guide walks you through setting up the AI-powered rule generation features in KRule.

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Quick Start](#quick-start)
3. [Detailed Setup](#detailed-setup)
4. [Environment Configuration](#environment-configuration)
5. [Database Setup](#database-setup)
6. [Testing the Implementation](#testing-the-implementation)
7. [Using the AI Features](#using-the-ai-features)
8. [Developer SDK Usage](#developer-sdk-usage)
9. [Troubleshooting](#troubleshooting)

---

## Prerequisites

Before you begin, ensure you have:

- Node.js 18+ installed
- pnpm installed (`npm install -g pnpm`)
- Docker and Docker Compose installed
- A Groq API key (free tier available at https://console.groq.com)

---

## Quick Start

```bash
# 1. Install dependencies
pnpm install

# 2. Copy environment variables
cp .env.example .env

# 3. Add your Groq API key to .env
# GROQ_API_KEY=gsk_your_key_here

# 4. Start PostgreSQL
docker-compose up -d

# 5. Generate Prisma client and push schema
cd packages/database
pnpm db:generate
pnpm db:push
cd ../..

# 6. Start development server
pnpm dev
```

Visit http://localhost:3000 and click on the ğŸ¤– AI Assistant tab in the Rule Builder!

---

## Detailed Setup

### 1. Install Dependencies

The project uses a monorepo structure with pnpm workspaces. Install all dependencies:

```bash
pnpm install
```

This will install dependencies for:
- `apps/web` - Next.js web application
- `packages/core` - Core rule engine
- `packages/database` - Prisma database client
- `packages/ai-service` - AI services with Groq
- `packages/ai-sdk` - Developer SDK

### 2. Get a Groq API Key

1. Visit https://console.groq.com
2. Sign up for a free account
3. Navigate to API Keys section
4. Create a new API key
5. Copy the key (starts with `gsk_`)

**Free Tier Limits:**
- 14,400 requests per day
- 500+ tokens/second
- Models: Llama 3.3 70B, Mixtral 8x7B, etc.

### 3. Configure Environment Variables

Create `.env` file in the project root:

```bash
cp .env.example .env
```

Edit `.env` and add your configuration:

```bash
# Groq API Configuration
GROQ_API_KEY=gsk_your_groq_api_key_here

# Database Configuration
DATABASE_URL=postgresql://postgres:password@localhost:5432/krule

# Optional: For production deployments
NODE_ENV=development
```

Also create `.env.local` in `apps/web/`:

```bash
cp apps/web/.env.local.example apps/web/.env.local
```

Edit `apps/web/.env.local`:

```bash
GROQ_API_KEY=gsk_your_groq_api_key_here
DATABASE_URL=postgresql://postgres:password@localhost:5432/krule
```

---

## Database Setup

### Option 1: Using Docker (Recommended)

The easiest way to set up PostgreSQL:

```bash
# Start PostgreSQL and pgAdmin
docker-compose up -d

# Check containers are running
docker ps
```

This will start:
- PostgreSQL on port 5432
- pgAdmin on http://localhost:5050

**pgAdmin Login:**
- Email: admin@krule.com
- Password: admin

### Option 2: Local PostgreSQL Installation

If you prefer to use a local PostgreSQL installation:

1. Install PostgreSQL 16+
2. Create a database named `krule`
3. Update `DATABASE_URL` in `.env` with your credentials

### Initialize Database Schema

```bash
cd packages/database

# Generate Prisma client
pnpm db:generate

# Push schema to database
pnpm db:push

# Optional: Open Prisma Studio to view data
pnpm db:studio
```

**Database Models Created:**
- `User` - User accounts
- `Conversation` - Chat conversation sessions
- `Message` - Individual chat messages
- `GeneratedRule` - Rules generated by AI
- `ValidationAttempt` - Rule validation history
- `ApiUsage` - API usage tracking

---

## Testing the Implementation

### 1. Start the Development Server

```bash
# From project root
pnpm dev
```

The web application will start at http://localhost:3000

### 2. Access the AI Assistant

1. Navigate to http://localhost:3000
2. You should see the Rule Builder interface
3. Click on the **ğŸ¤– AI Assistant** tab (first tab)
4. You'll see the chat interface

### 3. Test Rule Generation

Try these example prompts:

**Simple Discount Rule:**
```
Give VIP users 20% off when their cart is over $100
```

**Content Moderation:**
```
Flag content for review if it has more than 3 reports or negative sentiment
```

**Access Control:**
```
Block users who have more than 5 failed login attempts in the last hour
```

**Workflow Automation:**
```
Send a welcome email to new users and assign them to the onboarding queue
```

### 4. Test Conversational Refinement

After generating a rule, try refining it:

```
User: Create a discount rule for premium users
AI: [Generates rule]

User: Increase the discount to 25%
AI: [Updates rule]

User: Add a condition for orders over $50
AI: [Refines rule further]
```

### 5. Test API Endpoints

You can test the API directly:

**Generate Rule:**
```bash
curl -X POST http://localhost:3000/api/ai/generate \
  -H "Content-Type: application/json" \
  -d '{"prompt": "Give users 10% off on their first order"}'
```

**Explain Rule:**
```bash
curl -X POST http://localhost:3000/api/ai/explain \
  -H "Content-Type: application/json" \
  -d '{
    "rule": {
      "name": "First Order Discount",
      "priority": 50,
      "condition": {"field": "orderCount", "operator": "==", "value": 0},
      "actions": [{"type": "discount", "target": "cart", "payload": {"percentage": 10}}]
    },
    "type": "full"
  }'
```

---

## Using the AI Features

### In the Web UI

**1. AI Assistant Tab**
- Click the ğŸ¤– AI Assistant tab in Rule Builder
- Type your rule description in natural language
- Wait for the AI to generate the rule
- Review the generated rule in the preview panel

**2. Quick Actions**
- **ğŸ’¡ Explain** - Get plain English explanation of the rule
- **âœï¸ Refine** - Ask follow-up questions to modify the rule
- **âœ“ Accept Rule** - Add the rule to your rule set

**3. Conversation History**
- All messages are saved
- Rules are tracked in the database
- You can continue conversations later

### Via API Endpoints

Available endpoints at `/api/ai/`:

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/generate` | POST | Generate rule from prompt |
| `/chat` | POST | Streaming conversational endpoint |
| `/explain` | POST | Explain a rule in plain language |
| `/validate` | POST | Validate rule with AI assistance |
| `/test-scenarios` | POST | Generate test scenarios |
| `/conversations` | GET/POST | Manage conversations |
| `/conversations/[id]` | GET/PUT/DELETE | Single conversation CRUD |

---

## Developer SDK Usage

The `@repo/ai-sdk` package provides a TypeScript SDK for developers.

### Installation (External Projects)

```bash
# Once published
npm install @krule/ai-sdk
```

### Basic Usage

```typescript
import { KRuleAI } from "@repo/ai-sdk";

// Initialize client
const ai = new KRuleAI({
  baseUrl: "http://localhost:3000/api/ai",
  apiKey: "your-api-key", // Optional
});

// Generate a rule
const result = await ai.generateRule({
  prompt: "Give VIP users 20% off when their cart is over $100",
});

if (result.success) {
  console.log("Generated rule:", result.rule);
}
```

### Conversational Interface

```typescript
// Create conversation
const conversation = ai.createConversation("user-123");

// Multi-turn interaction
await conversation.send("Create a content moderation rule");
await conversation.send("Make it more strict");
await conversation.send("Add email notifications");

// Get final rule
const rule = conversation.getRule();
console.log("Final rule:", rule);
```

### Advanced Features

```typescript
// Explain a rule
const explanation = await ai.explainRule({
  rule: myRule,
  type: "full", // "full" | "conditions" | "actions" | "useCases"
});

// Validate a rule
const validation = await ai.validateRule({
  rule: myRule,
  userId: "user-123",
});

// Generate test scenarios
const tests = await ai.generateTests({
  rule: myRule,
  type: "suite", // "all" | "positive" | "negative" | "edge" | "suite"
  count: 5,
});
```

See `packages/ai-sdk/README.md` for complete documentation.

---

## Troubleshooting

### Database Connection Issues

**Problem:** `Error: Can't reach database server`

**Solution:**
```bash
# Check Docker containers
docker ps

# Restart PostgreSQL
docker-compose restart postgres

# Check logs
docker-compose logs postgres
```

### Groq API Errors

**Problem:** `Error: Invalid API key`

**Solution:**
- Verify your API key in `.env` and `apps/web/.env.local`
- Ensure the key starts with `gsk_`
- Check you haven't exceeded rate limits

**Problem:** `Error: Rate limit exceeded`

**Solution:**
- Free tier allows 14,400 requests/day
- Wait for rate limit to reset (daily)
- Consider upgrading to paid tier for higher limits

### Prisma Client Issues

**Problem:** `@prisma/client did not initialize yet`

**Solution:**
```bash
cd packages/database
pnpm db:generate
cd ../..
pnpm install
```

### Build Errors

**Problem:** TypeScript errors during build

**Solution:**
```bash
# Clean and rebuild
pnpm clean
pnpm install
pnpm build
```

### Port Conflicts

**Problem:** `Port 3000 already in use`

**Solution:**
```bash
# Find and kill process
lsof -ti:3000 | xargs kill -9

# Or use different port
PORT=3001 pnpm dev
```

---

## Architecture Overview

```
krule/
â”œâ”€â”€ apps/web/                    # Next.js application
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ api/ai/             # AI API routes
â”‚   â”‚   â”‚   â”œâ”€â”€ generate/       # Rule generation
â”‚   â”‚   â”‚   â”œâ”€â”€ chat/           # Streaming chat
â”‚   â”‚   â”‚   â”œâ”€â”€ explain/        # Rule explanation
â”‚   â”‚   â”‚   â”œâ”€â”€ validate/       # Validation
â”‚   â”‚   â”‚   â””â”€â”€ test-scenarios/ # Test generation
â”‚   â”‚   â””â”€â”€ components/
â”‚   â”‚       â”œâ”€â”€ AIAssistant.tsx # Main AI interface
â”‚   â”‚       â””â”€â”€ chat/           # Chat subcomponents
â”‚   â””â”€â”€ package.json
â”‚
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ ai-service/             # AI service layer
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ groq-client.ts  # Groq API wrapper
â”‚   â”‚       â”œâ”€â”€ rule-generator.ts
â”‚   â”‚       â”œâ”€â”€ rule-explainer.ts
â”‚   â”‚       â”œâ”€â”€ validator.ts
â”‚   â”‚       â”œâ”€â”€ test-generator.ts
â”‚   â”‚       â””â”€â”€ prompts.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ ai-sdk/                 # Developer SDK
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â”œâ”€â”€ client.ts       # KRuleAI class
â”‚   â”‚       â””â”€â”€ index.ts
â”‚   â”‚
â”‚   â”œâ”€â”€ database/               # Prisma database
â”‚   â”‚   â”œâ”€â”€ prisma/
â”‚   â”‚   â”‚   â””â”€â”€ schema.prisma   # Database schema
â”‚   â”‚   â””â”€â”€ src/
â”‚   â”‚       â””â”€â”€ index.ts        # Prisma client
â”‚   â”‚
â”‚   â””â”€â”€ core/                   # Core rule engine
â”‚       â””â”€â”€ evaluators/         # Rule evaluation
â”‚
â””â”€â”€ docker-compose.yml          # PostgreSQL setup
```

---

## Next Steps

1. **Customize Prompts**: Edit `packages/ai-service/src/prompts.ts` to adjust AI behavior
2. **Add Authentication**: Integrate user authentication for multi-user support
3. **Deploy to Production**:
   - Set up hosted PostgreSQL (e.g., Supabase, Neon)
   - Deploy to Vercel/Railway
   - Add environment variables in deployment platform
4. **Monitor Usage**: Use the `ApiUsage` table to track API consumption
5. **Extend Features**:
   - Add rule templates
   - Implement rule versioning
   - Add collaborative editing

---

## Support

- **Documentation**: See individual package READMEs
  - `packages/ai-sdk/README.md` - SDK documentation
  - `packages/database/README.md` - Database setup
  - `packages/ai-service/README.md` - AI service details

- **Issues**: Check console logs and Docker logs for errors
- **Database**: Use Prisma Studio (`pnpm db:studio`) to inspect data

---

## Summary

You now have a complete AI-powered rule generation system with:

- âœ… Natural language to rule conversion
- âœ… Interactive chat interface
- âœ… Multi-turn conversational refinement
- âœ… Rule explanation and validation
- âœ… Automatic test scenario generation
- âœ… Full PostgreSQL backend
- âœ… Developer SDK for programmatic access
- âœ… Free tier LLM (Groq with Llama 3.3)

**Ready to use:** Open http://localhost:3000 and start generating rules with AI!
